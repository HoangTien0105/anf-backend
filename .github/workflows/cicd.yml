name: Deploy to Self-hosted Server
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{ secrets.SSH_PORT }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script_stop: true
        timeout: 60s
        command_timeout: 10m
        script: |
          set -e
          
          # Load environment profiles to ensure PATH includes dotnet tools
          source ~/.profile
          source ~/.bashrc
          
          # If you use .NET version manager, load it
          export DOTNET_ROOT=$HOME/.dotnet
          export PATH=$PATH:$HOME/.dotnet:$HOME/.dotnet/tools
          
          echo "Checking dotnet version and tools..."
          dotnet --version || { echo "dotnet not found in PATH"; exit 1; }
          
          echo "Deploying to server..."
          cd ${{ secrets.PROJECT_DIRECTORY }} || { echo "Failed to navigate to project directory"; exit 1; }
          
          echo "Updating source code..."
          git fetch origin main || { echo "Failed to fetch from remote"; exit 1; }
          git reset --hard origin/main || { echo "Failed to reset to origin/main"; exit 1; }
          
          echo "Publishing application..."
          dotnet publish SEP490.AffiliateNetwork/ANF.Application/ANF.Application.csproj \
            -c Release \
            -o publish \
            --self-contained true \
            || { echo "Publish failed"; exit 1; }
            
          echo "Installing EF Core tools globally if needed..."
          dotnet tool list --global | grep dotnet-ef || dotnet tool install --global dotnet-ef
          
          # Check if EF tool is available now
          which dotnet-ef || { 
            echo "dotnet-ef still not found in PATH after installation"; 
            echo "Current PATH: $PATH";
            exit 1; 
          }
          
          echo "Applying database migrations..."
          cd SEP490.AffiliateNetwork || { echo "Failed to navigate to project directory"; exit 1; }
          
          # Run migration with full path to be safe
          $HOME/.dotnet/tools/dotnet-ef database update \
            --project ANF.Infrastructure/ANF.Infrastructure.csproj \
            --startup-project ANF.Application/ANF.Application.csproj \
            || { echo "Database migration failed"; exit 1; }
          cd ..
          
          echo "Restarting service..."
          sudo systemctl restart myapp || { echo "Failed to restart service"; exit 1; }
          
          # Verify service is running
          sleep 5
          if ! sudo systemctl is-active --quiet myapp; then
            echo "Service failed to start properly!"
            sudo systemctl status myapp
            exit 1
          fi
          
          echo "Deployment completed successfully!"
